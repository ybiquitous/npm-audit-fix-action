name: Update built files

on:
  pull_request:
    types: [assigned]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm

      - name: Install dependencies
        run: |
          npm --global install npm@latest
          npm ci

      - name: Check for file changes
        id: check-changes
        shell: bash
        run: |
          if git diff --exit-code; then
            echo "No changes."
          else
            echo "continue=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Commit and push a built file if any changes
        if: ${{ steps.check-changes.outputs.continue == 'true' }}
        uses: actions/github-script@v7
        with:
          # github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # PAT is necessary to trigger other workflows on push
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            const { owner, repo } = context.repo;
            const { ref: branch } = context.payload.pull_request.head;

            for (const filename of fs.readdirSync('dist')) {
              const path = `dist/${filename}`;
              const content = fs.readFileSync(path, 'utf8');
              const sha = execSync(`git log -1 --format=%H -- "${path}"`).toString().trim();
              await github.rest.repos.createOrUpdateFileContents({
                owner,
                repo,
                branch,
                sha,
                path,
                message: `build: update \`${filename}\``,
                content: Buffer.from(content).toString('base64'),
              });
            }
